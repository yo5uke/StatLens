---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/Navigation.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';

const allPosts = await getCollection('posts');
const publishedPosts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const categories = [...new Set(publishedPosts.map(post => post.data.category))];
---

<BaseLayout title="All Posts">
  <Navigation />

  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <section class="mb-12">
      <h1 class="text-4xl font-bold mb-4">All Posts</h1>
      <p class="text-gray-600 dark:text-gray-400">
        技術記事の一覧です。カテゴリでフィルタリングできます。
      </p>
    </section>

    <div class="mb-8">
      <div class="flex flex-wrap gap-2" id="category-filters">
        <button
          class="category-filter px-4 py-2 rounded-full text-sm font-medium transition-colors bg-[#98D8C8] text-gray-900"
          data-category="all"
        >
          All
        </button>
        {categories.map(category => (
          <button
            class="category-filter px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-[#98D8C8] hover:text-gray-900"
            data-category={category}
          >
            {category}
          </button>
        ))}
      </div>
    </div>

    <div class="grid gap-6" id="posts-container">
      {publishedPosts.map((post) => (
        <div class="post-item" data-category={post.data.category}>
          <PostCard
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            category={post.data.category}
            slug={post.slug}
          />
        </div>
      ))}
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  const filterButtons = document.querySelectorAll('.category-filter');
  const postItems = document.querySelectorAll('.post-item');

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');

      filterButtons.forEach(btn => {
        btn.classList.remove('bg-[#98D8C8]', 'text-gray-900');
        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      });

      button.classList.add('bg-[#98D8C8]', 'text-gray-900');
      button.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');

      postItems.forEach(item => {
        if (category === 'all' || item.getAttribute('data-category') === category) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });
</script>
